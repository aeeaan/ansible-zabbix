---
- name: install zabbix repo rpm
  yum: name=http://repo.zabbix.com/zabbix/2.4/rhel/7/x86_64/zabbix-release-2.4-1.el7.noarch.rpm state=present
  when: ansible_os_family == 'RedHat' and ansible_distribution_major_version|int == 7

- name: create zabbix group
  group: name=zabbix gid=130 state=present

- name: create zabbix user
  user: name=zabbix uid=130 group=zabbix comment="Zabbix Monitoring System" home=/var/lib/zabbix shell=/sbin/nologin state=present

- name: ensure time zone is set
  ini_file: dest=/etc/php.ini section="Date" option="date.timezone" value="America/New_York"

- name: create db
  mysql_db: name=zabbix state=present encoding=utf8

- name: create db user
  mysql_user: name={{ zabbix_server_db_user }} host={{ item }} password={{ zabbix_server_db_pass }} login_host={{ zabbix_server_db_hostname }} priv={{ zabbix_server_db_name }}.*:ALL
  with_items:
   - 127.0.0.1
   - ::1
   - localhost

- name: install zabbix server
  yum: name=zabbix state=present

- name: install zabbix server mysql
  yum: name=zabbix-server-mysql state=present
  notify: initialize zabbix database

- name: install zabbix agent
  yum: name=zabbix-agent state=present

- name: install zabbix frontend
  yum: name=zabbix-web-mysql state=present

- name: enable web ports
  firewalld: service={{item}} permanent=true state=enabled
  with_items:
      - http
      - https

